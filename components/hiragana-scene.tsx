"use client";

import { useState, useRef, useEffect, useCallback } from "react";
import { Button } from "@/components/ui/button";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { X, RotateCcw } from "lucide-react";
import {
  hiraganaData,
  strokeOrderData,
  type HiraganaItem,
} from "@/lib/hiragana-data";

interface HiraganaSceneProps {
  onHiraganaClick: (item: HiraganaItem) => void;
  kotoItem?: HiraganaItem;
  akariItem?: HiraganaItem;
  ayumuItem?: HiraganaItem;
  mionaItem?: HiraganaItem;
  mitsukiItem?: HiraganaItem;
  yattyanItem?: HiraganaItem;
  onKotoClick?: () => void;
}

export default function HiraganaScene({
  onHiraganaClick,
  kotoItem,
  akariItem,
  ayumuItem,
  mionaItem,
  mitsukiItem,
  yattyanItem,
  onKotoClick,
}: HiraganaSceneProps) {
  const [selectedCharacter, setSelectedCharacter] = useState<string | null>(
    null
  );
  const [isModalOpen, setIsModalOpen] = useState(false);

  const [isTracing, setIsTracing] = useState(false);
  const [userStrokes, setUserStrokes] = useState<string[]>([]);
  const [showResult, setShowResult] = useState(false);
  const [isCorrect, setIsCorrect] = useState(false);
  const [showHanamaru, setShowHanamaru] = useState(false);
  const [hasUserDrawing, setHasUserDrawing] = useState(false);
  const canvasRef = useRef<HTMLCanvasElement | null>(null);

  // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Çπ„Çø„Ç§„É´
  const animationStyles = `
  @keyframes sparkle {
    0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
    50% { transform: scale(1.2) rotate(180deg); opacity: 0.8; }
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }
  
  .sparkle-animation {
    animation: sparkle 2s ease-in-out infinite;
  }
  
  .float-animation {
    animation: float 3s ease-in-out infinite;
  }
`;

  // „Çπ„Çø„Ç§„É´„ÇíÊ≥®ÂÖ•
  useEffect(() => {
    const styleElement = document.createElement("style");
    styleElement.textContent = animationStyles;
    document.head.appendChild(styleElement);

    return () => {
      document.head.removeChild(styleElement);
    };
  }, []);

  // Èü≥Â£∞„Ç≠„É£„ÉÉ„Ç∑„É•Áî®„ÅÆMap
  const audioCache = useRef(new Map<string, string>()).current;

  // „ÇØ„É™„ÉÉ„ÇØÂäπÊûúÈü≥„ÇíÁîüÊàê„Åô„ÇãÈñ¢Êï∞
  const playClickSound = useCallback(() => {
    try {
      const audioContext = new (window.AudioContext ||
        (window as any).webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      // „ÇØ„É™„ÉÉ„ÇØÈü≥„ÅÆË®≠ÂÆö
      oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // 800Hz
      oscillator.frequency.exponentialRampToValueAtTime(
        400,
        audioContext.currentTime + 0.1
      ); // 400Hz„Å´‰∏ã„Åå„Çã

      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); // Èü≥Èáè
      gainNode.gain.exponentialRampToValueAtTime(
        0.01,
        audioContext.currentTime + 0.1
      ); // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    } catch (error) {
      console.log("ÂäπÊûúÈü≥„ÅÆÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", error);
    }
  }, []);

  // Text-to-speech function (ÊúÄÈÅ©ÂåñÁâà)
  const speakText = useCallback(
    async (text: string, lang = "ja-JP") => {
      try {
        // „Ç≠„É£„ÉÉ„Ç∑„É•„Ç≠„Éº„Çí‰ΩúÊàê
        const cacheKey = `${text}-ja-JP-Neural2-C`;

        // „Ç≠„É£„ÉÉ„Ç∑„É•„Åï„Çå„ÅüÈü≥Â£∞„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if (audioCache.has(cacheKey)) {
          const cachedUrl = audioCache.get(cacheKey)!;
          const audio = new Audio(cachedUrl);
          await audio.play();
          console.log("‚òÅÔ∏è „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâÈü≥Â£∞„ÇíÂÜçÁîü");
          return;
        }

        // TTS API„ÇíÂëº„Å≥Âá∫„Åó
        const startTime = performance.now();
        const response = await fetch("/api/tts", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            text: text,
            voice: "ja-JP-Neural2-C",
          }),
        });

        if (!response.ok) {
          throw new Error("TTS API request failed");
        }

        const data = await response.json();
        const apiTime = performance.now() - startTime;

        // ÈùûÂêåÊúü„ÅßÈü≥Â£∞„Éá„Éº„Çø„ÇíÂá¶ÁêÜ
        const processStartTime = performance.now();
        const audioBlob = new Blob(
          [Uint8Array.from(atob(data.audio), (c) => c.charCodeAt(0))],
          { type: data.format }
        );

        const audioUrl = URL.createObjectURL(audioBlob);
        const processTime = performance.now() - processStartTime;

        // „Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò
        audioCache.set(cacheKey, audioUrl);

        const audio = new Audio(audioUrl);

        // ÂÜçÁîüÈñãÂßã
        await audio.play();
        const totalTime = performance.now() - startTime;

        console.log("üéµ TTS „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ:", {
          apiTime: `${apiTime.toFixed(2)}ms`,
          processTime: `${processTime.toFixed(2)}ms`,
          totalTime: `${totalTime.toFixed(2)}ms`,
          cacheSize: audioCache.size,
        });
      } catch (error) {
        console.error("TTS Error:", error);
        console.log("üîÑ Falling back to Web Speech API");
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Web Speech API„Çí‰ΩøÁî®
        if ("speechSynthesis" in window) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = lang;
          utterance.rate = 0.7;
          utterance.pitch = 1.2;
          utterance.volume = 0.9;
          speechSynthesis.speak(utterance);
        }
      }
    },
    [audioCache]
  );

  const handleCharacterClick = useCallback(
    (item: HiraganaItem) => {
      console.log("üé¨ handleCharacterClick„ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü:", item);
      playClickSound(); // „ÇØ„É™„ÉÉ„ÇØÂäπÊûúÈü≥„ÇíÂÜçÁîü
      setSelectedCharacter(item.character);
      setIsModalOpen(true);
      setUserStrokes([]);
      setShowResult(false);
      setIsCorrect(false);
      setShowHanamaru(false);
      setHasUserDrawing(false);
      speakText(item.word);
      onHiraganaClick(item);
      console.log("‚úÖ „ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñã„Åç„Åæ„Åó„Åü");
    },
    [onHiraganaClick, speakText, playClickSound]
  );

  const handleKotoClick = useCallback(() => {
    console.log("üéØ handleKotoClick„ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü");
    if (kotoItem) {
      console.log("üìù kotoItem:", kotoItem);
      handleCharacterClick(kotoItem);
    } else {
      console.log("‚ùå kotoItem„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
    }
  }, [kotoItem, handleCharacterClick]);

  const handleAkariClick = useCallback(() => {
    console.log("üéØ handleAkariClick„ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü");
    if (akariItem) {
      console.log("üìù akariItem:", akariItem);
      handleCharacterClick(akariItem);
    } else {
      console.log("‚ùå akariItem„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
    }
  }, [akariItem, handleCharacterClick]);

  const handleAyumuClick = useCallback(() => {
    console.log("üéØ handleAyumuClick„ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü");
    if (ayumuItem) {
      console.log("üìù ayumuItem:", ayumuItem);
      handleCharacterClick(ayumuItem);
    } else {
      console.log("‚ùå ayumuItem„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
    }
  }, [ayumuItem, handleCharacterClick]);

  const handleMionaClick = useCallback(() => {
    console.log("üéØ handleMionaClick„ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü");
    if (mionaItem) {
      console.log("üìù mionaItem:", mionaItem);
      handleCharacterClick(mionaItem);
    } else {
      console.log("‚ùå mionaItem„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
    }
  }, [mionaItem, handleCharacterClick]);

  const handleMitsukiClick = useCallback(() => {
    console.log("üéØ handleMitsukiClick„ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü");
    if (mitsukiItem) {
      console.log("üìù mitsukiItem:", mitsukiItem);
      handleCharacterClick(mitsukiItem);
    } else {
      console.log("‚ùå mitsukiItem„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
    }
  }, [mitsukiItem, handleCharacterClick]);

  const handleYattyanClick = useCallback(() => {
    console.log("üéØ handleYattyanClick„ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü");
    if (yattyanItem) {
      console.log("üìù yattyanItem:", yattyanItem);
      handleCharacterClick(yattyanItem);
    } else {
      console.log("‚ùå yattyanItem„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
    }
  }, [yattyanItem, handleCharacterClick]);

  // Â§ñÈÉ®„Åã„Çâ„ÅÆÂèãÈÅî„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇØ„É™„ÉÉ„ÇØ„ÇíÂá¶ÁêÜ
  useEffect(() => {
    // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶handleKotoClick„ÇíÂÖ¨Èñã
    (window as any).triggerKotoClick = () => {
      console.log("üåê „Ç∞„É≠„Éº„Éê„É´triggerKotoClick„ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü");
      handleKotoClick();
    };

    // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶handleAkariClick„ÇíÂÖ¨Èñã
    (window as any).triggerAkariClick = () => {
      console.log("üåê „Ç∞„É≠„Éº„Éê„É´triggerAkariClick„ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü");
      handleAkariClick();
    };

    (window as any).triggerAyumuClick = () => {
      console.log("üåê „Ç∞„É≠„Éº„Éê„É´triggerAyumuClick„ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü");
      handleAyumuClick();
    };

    (window as any).triggerMionaClick = () => {
      console.log("üåê „Ç∞„É≠„Éº„Éê„É´triggerMionaClick„ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü");
      handleMionaClick();
    };

    (window as any).triggerMitsukiClick = () => {
      console.log("üåê „Ç∞„É≠„Éº„Éê„É´triggerMitsukiClick„ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü");
      handleMitsukiClick();
    };

    (window as any).triggerYattyanClick = () => {
      console.log("üåê „Ç∞„É≠„Éº„Éê„É´triggerYattyanClick„ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü");
      handleYattyanClick();
    };

    return () => {
      delete (window as any).triggerKotoClick;
      delete (window as any).triggerAkariClick;
      delete (window as any).triggerAyumuClick;
      delete (window as any).triggerMionaClick;
      delete (window as any).triggerMitsukiClick;
      delete (window as any).triggerYattyanClick;
    };
  }, [
    handleKotoClick,
    handleAkariClick,
    handleAyumuClick,
    handleMionaClick,
    handleMitsukiClick,
    handleYattyanClick,
  ]);

  const resetStrokes = () => {
    setUserStrokes([]);
    setShowResult(false);
    setIsCorrect(false);
    setShowHanamaru(false);
    setHasUserDrawing(false);
    if (canvasRef.current) {
      const ctx = canvasRef.current.getContext("2d");
      if (ctx) {
        ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
      }
    }
  };

  // page.tsx„Çπ„Çø„Ç§„É´„ÅÆÂà§ÂÆöÈñ¢Êï∞
  const checkDrawing = () => {
    if (hasUserDrawing) {
      setShowHanamaru(true);

      // Ëä±‰∏∏Ë°®Á§∫ÊôÇ„Å´Èü≥Â£∞Ë™≠„Åø‰∏ä„Åí
      const congratsText = `„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ`;
      // const congratsText = `„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ„Äå${selectedCharacter}„Äç„Åå „Åò„Çá„ÅÜ„Åö„Å´ „Åã„Åë„Åæ„Åó„Åü„Å≠ÔºÅ`;
      speakText(congratsText);

      // „Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÊèèÁîª„Çí„É™„Çª„ÉÉ„Éà
      if (canvasRef.current) {
        const ctx = canvasRef.current.getContext("2d");
        if (ctx) {
          ctx.clearRect(
            0,
            0,
            canvasRef.current.width,
            canvasRef.current.height
          );
        }
      }
      setUserStrokes([]);
      setHasUserDrawing(false);

      setTimeout(() => {
        setShowHanamaru(false);
      }, 4000); // 4ÁßíÂæå„Å´Ëä±‰∏∏„ÇíÈùûË°®Á§∫
    }
  };

  const startTracing = (
    e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>
  ) => {
    setIsTracing(true);
    setHasUserDrawing(true);
    setShowResult(false); // Êñ∞„Åó„ÅèÊèè„ÅçÂßã„ÇÅ„Åü„ÇâÁµêÊûú„Çí„É™„Çª„ÉÉ„Éà
    const canvas = canvasRef.current;
    if (!canvas) return;

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;

    const x =
      ("touches" in e
        ? e.touches[0].clientX - rect.left
        : e.clientX - rect.left) * scaleX;
    const y =
      ("touches" in e
        ? e.touches[0].clientY - rect.top
        : e.clientY - rect.top) * scaleY;

    const ctx = canvas.getContext("2d");
    if (ctx) {
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.strokeStyle = "#3b82f6";
      ctx.lineWidth = 4;
      ctx.lineCap = "round";

      // Êñ∞„Åó„ÅÑ„Çπ„Éà„É≠„Éº„ÇØ„ÇíÈñãÂßã
      setUserStrokes((prev) => [...prev, `M${x},${y}`]);
    }
  };

  const trace = (
    e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>
  ) => {
    if (!isTracing) return;

    const canvas = canvasRef.current;
    if (!canvas) return;

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;

    const x =
      ("touches" in e
        ? e.touches[0].clientX - rect.left
        : e.clientX - rect.left) * scaleX;
    const y =
      ("touches" in e
        ? e.touches[0].clientY - rect.top
        : e.clientY - rect.top) * scaleY;

    const ctx = canvas.getContext("2d");
    if (ctx) {
      ctx.lineTo(x, y);
      ctx.stroke();

      // „Çπ„Éà„É≠„Éº„ÇØÊÉÖÂ†±„ÇíË®òÈå≤
      setUserStrokes((prev) => {
        const newStrokes = [...prev];
        if (newStrokes.length > 0) {
          newStrokes[newStrokes.length - 1] += ` L${x},${y}`;
        }
        return newStrokes;
      });
    }
  };

  const stopTracing = () => {
    setIsTracing(false);
  };

  // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫„Çí„É¨„Çπ„Éù„É≥„Ç∑„Éñ„Å´Ë™øÊï¥
  useEffect(() => {
    if (canvasRef.current) {
      const canvas = canvasRef.current;
      const updateCanvasSize = () => {
        const isSmallScreen = window.innerWidth < 640;
        canvas.width = isSmallScreen ? 280 : 350;
        canvas.height = isSmallScreen ? 160 : 200;
      };

      updateCanvasSize();
      window.addEventListener("resize", updateCanvasSize);

      return () => {
        window.removeEventListener("resize", updateCanvasSize);
      };
    }
  }, [selectedCharacter]);

  useEffect(() => {
    if (
      canvasRef.current &&
      selectedCharacter &&
      strokeOrderData[selectedCharacter]
    ) {
      const canvas = canvasRef.current;
      const ctx = canvas.getContext("2d");
      if (ctx) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ËñÑ„ÅÑ„Ç¨„Ç§„Éâ„É©„Ç§„É≥„ÇíË°®Á§∫
        ctx.strokeStyle = "#e5e7eb";
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);

        const strokes =
          selectedCharacter === "„ÇÑ„Å≥„Åè „Åì„Å®"
            ? kotoStrokeData.strokes
            : strokeOrderData[selectedCharacter]?.strokes || [];

        strokes.forEach((strokeData) => {
          const path = new Path2D(strokeData.path);
          ctx.stroke(path);

          // Êõ∏„ÅçÈ†ÜÁï™Âè∑„ÇíË°®Á§∫
          ctx.setLineDash([]);
          ctx.fillStyle = "#ef4444";
          ctx.font = "bold 16px sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";

          // Áï™Âè∑„ÅÆËÉåÊôØÂÜÜ„ÇíÊèèÁîª
          ctx.beginPath();
          ctx.arc(
            strokeData.startPoint[0],
            strokeData.startPoint[1],
            12,
            0,
            2 * Math.PI
          );
          ctx.fillStyle = "#ffffff";
          ctx.fill();
          ctx.strokeStyle = "#ef4444";
          ctx.lineWidth = 2;
          ctx.stroke();

          // Áï™Âè∑„ÇíÊèèÁîª
          ctx.fillStyle = "#ef4444";
          ctx.fillText(
            strokeData.number.toString(),
            strokeData.startPoint[0],
            strokeData.startPoint[1]
          );

          // Ê¨°„ÅÆÊèèÁîª„ÅÆ„Åü„ÇÅ„Å´„É™„Çª„ÉÉ„Éà
          ctx.strokeStyle = "#e5e7eb";
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
        });

        ctx.setLineDash([]);
      }
    }
  }, [selectedCharacter]);

  // „Äå„Åì„Å®„Äç„ÅÆÊõ∏„ÅçÈ†Ü„Éá„Éº„Çø
  const kotoStrokeData = {
    strokes: [
      { path: "M30,30 L70,30", number: 1, startPoint: [30, 30] },
      { path: "M30,60 Q50,50 70,60", number: 2, startPoint: [30, 60] },
      { path: "M40,20 L40,80", number: 3, startPoint: [40, 20] },
      { path: "M60,30 Q70,50 60,70", number: 4, startPoint: [60, 30] },
    ],
    description: "‚ë†Ê®™Á∑ö„ÄÅ‚ë°‰∏ã„ÅÆÊõ≤Á∑ö„ÄÅ‚ë¢Á∏¶Á∑ö„ÄÅ‚ë£Âè≥„ÅÆÊõ≤Á∑ö„ÅÆÈ†ÜÁï™„ÅßÊõ∏„Åç„Åæ„Åô",
  };

  // ÂêÑË°å„Åî„Å®„Å´Á∏¶„Å´‰∏¶„Åπ„ÇãÔºà„ÅÇË°å„ÄÅ„ÅãË°å‚Ä¶„ÇÑË°å„ÄÅ„ÇâË°å„ÄÅ„ÇèË°åÔºâ
  const rowsData = [
    hiraganaData.filter((item) => item.row === "„ÅÇË°å"),
    hiraganaData.filter((item) => item.row === "„ÅãË°å"),
    hiraganaData.filter((item) => item.row === "„ÅïË°å"),
    hiraganaData.filter((item) => item.row === "„ÅüË°å"),
    hiraganaData.filter((item) => item.row === "„Å™Ë°å"),
    hiraganaData.filter((item) => item.row === "„ÅØË°å"),
    hiraganaData.filter((item) => item.row === "„ÅæË°å"),
    hiraganaData.filter((item) => item.row === "„ÇÑË°å"),
    hiraganaData.filter((item) => item.row === "„ÇâË°å"),
    hiraganaData.filter((item) => item.row === "„ÇèË°å"),
  ];

  // „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Âêë„Åë„ÅÆ„Ç∞„É´„Éº„ÉóÂàÜ„Åë
  const topGroupRows = rowsData.slice(0, 5); // „ÅÇË°å„Äú„Å™Ë°å
  const bottomGroupRows = rowsData.slice(5); // „ÅØË°å„Äú„ÇèË°å

  return (
    <div className="w-full px-1" data-hiragana-scene>
      {/* „Éá„Çπ„ÇØ„Éà„ÉÉ„Éó„É¨„Ç§„Ç¢„Ç¶„Éà: Ê®™‰∏ÄÂàóË°®Á§∫ */}
      <div className="hidden sm:block">
        <div className="flex flex-row-reverse justify-center gap-1 sm:gap-2 md:gap-3 lg:gap-4">
          {rowsData.map((col, colIdx) => (
            <div
              key={colIdx}
              className="flex flex-col gap-2 sm:gap-3 md:gap-4 flex-1"
            >
              {col.map((item) => (
                <div
                  key={item.id}
                  className="relative cursor-pointer transform transition-all duration-300 hover:scale-105"
                  onClick={() => handleCharacterClick(item)}
                >
                  {/* „É°„Ç§„É≥„Éñ„É≠„ÉÉ„ÇØÔºö„Å≤„Çâ„Åå„Å™ÊñáÂ≠ó„Å®„Ç¢„Ç§„Ç≥„É≥„ÇíÁµ±Âêà */}
                  <div className="bg-white/80 backdrop-blur-sm rounded-lg sm:rounded-xl md:rounded-2xl py-3 shadow-xl border-2 border-white/30 w-full">
                    <div className="flex items-center justify-center gap-0.5 sm:gap-1 w-full">
                      {/* „Å≤„Çâ„Åå„Å™ÊñáÂ≠ó */}
                      <div
                        className="aspect-square w-[40%] max-w-14 min-w-8 rounded-lg sm:rounded-xl md:rounded-2xl shadow-lg border-2 sm:border-3 md:border-4 border-white flex items-center justify-center relative overflow-hidden"
                        style={{ backgroundColor: item.color }}
                      >
                        <div className="text-sm sm:text-lg md:text-xl lg:text-2xl font-bold text-white drop-shadow-lg">
                          {item.character}
                        </div>
                      </div>

                      {/* „Ç¢„Ç§„Ç≥„É≥„Å®ÂçòË™û */}
                      <div className="flex flex-col items-center gap-0.5 sm:gap-1 w-[40%]">
                        {item.image && (
                          <div className="aspect-square w-full max-w-12 min-w-6 flex items-center justify-center overflow-hidden">
                            <img
                              src={item.image}
                              alt={item.word}
                              className="w-full h-full object-cover rounded"
                            />
                          </div>
                        )}
                        {/* <span className="text-xs font-medium text-gray-700 text-center leading-tight max-w-16">
                           {item.word}
                         </span> */}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ))}
        </div>
      </div>

      {/* „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥„É¨„Ç§„Ç¢„Ç¶„Éà: 2ÊÆµÊßãÈÄ† */}
      <div className="block sm:hidden space-y-8">
        {/* ‰∏äÊÆµ: „ÅÇË°å„Äú„Å™Ë°å */}
        <div className="flex flex-row-reverse justify-center gap-1">
          {topGroupRows.map((col, colIdx) => (
            <div key={colIdx} className="flex flex-col gap-2 flex-1">
              {col.map((item) => (
                <div
                  key={item.id}
                  className="relative cursor-pointer transform transition-all duration-300 hover:scale-105"
                  onClick={() => handleCharacterClick(item)}
                >
                  {/* „É°„Ç§„É≥„Éñ„É≠„ÉÉ„ÇØÔºö„Å≤„Çâ„Åå„Å™ÊñáÂ≠ó„Å®„Ç¢„Ç§„Ç≥„É≥„ÇíÁµ±Âêà */}
                  <div className="bg-white/80 backdrop-blur-sm rounded-lg py-3 shadow-xl border-2 border-white/30 w-full">
                    <div className="flex items-center justify-center gap-0.5 w-full">
                      {/* „Å≤„Çâ„Åå„Å™ÊñáÂ≠ó */}
                      <div
                        className="aspect-square w-[40%] max-w-14 min-w-8 rounded-lg shadow-lg border-2 border-white flex items-center justify-center relative overflow-hidden"
                        style={{ backgroundColor: item.color }}
                      >
                        <div className="text-sm font-bold text-white drop-shadow-lg">
                          {item.character}
                        </div>
                      </div>

                      {/* „Ç¢„Ç§„Ç≥„É≥„Å®ÂçòË™û */}
                      <div className="flex flex-col items-center gap-0.5 w-[40%]">
                        {item.image && (
                          <div className="aspect-square w-full max-w-12 min-w-6 flex items-center justify-center overflow-hidden">
                            <img
                              src={item.image}
                              alt={item.word}
                              className="w-full h-full object-cover rounded"
                            />
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ))}
        </div>

        {/* ‰∏ãÊÆµ: „ÅØË°å„Äú„ÇèË°å */}
        <div className="flex flex-row-reverse justify-center gap-1 pt-4">
          {bottomGroupRows.map((col, colIdx) => (
            <div key={colIdx} className="flex flex-col gap-2 flex-1">
              {col.map((item) => (
                <div
                  key={item.id}
                  className="relative cursor-pointer transform transition-all duration-300 hover:scale-105"
                  onClick={() => handleCharacterClick(item)}
                >
                  {/* „É°„Ç§„É≥„Éñ„É≠„ÉÉ„ÇØÔºö„Å≤„Çâ„Åå„Å™ÊñáÂ≠ó„Å®„Ç¢„Ç§„Ç≥„É≥„ÇíÁµ±Âêà */}
                  <div className="bg-white/80 backdrop-blur-sm rounded-lg py-3 shadow-xl border-2 border-white/30 w-full">
                    <div className="flex items-center justify-center gap-0.5 w-full">
                      {/* „Å≤„Çâ„Åå„Å™ÊñáÂ≠ó */}
                      <div
                        className="aspect-square w-[40%] max-w-14 min-w-8 rounded-lg shadow-lg border-2 border-white flex items-center justify-center relative overflow-hidden"
                        style={{ backgroundColor: item.color }}
                      >
                        <div className="text-sm font-bold text-white drop-shadow-lg">
                          {item.character}
                        </div>
                      </div>

                      {/* „Ç¢„Ç§„Ç≥„É≥„Å®ÂçòË™û */}
                      <div className="flex flex-col items-center gap-0.5 w-[40%]">
                        {item.image && (
                          <div className="aspect-square w-full max-w-12 min-w-6 flex items-center justify-center overflow-hidden">
                            <img
                              src={item.image}
                              alt={item.word}
                              className="w-full h-full object-cover rounded"
                            />
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ))}
        </div>
      </div>

      {/* Êõ∏„ÅçÈ†ÜÁ∑¥Áøí„É¢„Éº„ÉÄ„É´ */}
      <Dialog open={isModalOpen} onOpenChange={setIsModalOpen}>
        <DialogContent className="max-w-[95%] sm:max-w-[70%] mx-auto bg-white/90 backdrop-blur-sm select-none">
          <DialogHeader>
            <DialogTitle className="text-center text-lg sm:text-2xl">
              „Äå{selectedCharacter}„Äç„ÅÆ „Çå„Çì„Åó„ÇÖ„ÅÜ
            </DialogTitle>
          </DialogHeader>

          <div className="space-y-4">
            {/* Â§ß„Åç„Å™ÊñáÂ≠óË°®Á§∫ */}
            <div className="text-center">
              <div className="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4 mb-2">
                <div className="text-5xl sm:text-8xl font-bold text-gray-800">
                  {selectedCharacter}
                </div>
                {selectedCharacter && (
                  <div className="flex-shrink-0">
                    <img
                      src={
                        selectedCharacter === "„ÇÑ„Å≥„Åè „Åì„Å®"
                          ? "/images/koto.png"
                          : selectedCharacter === "„ÅÇ„Åã„Çä"
                          ? "/images/akari.png"
                          : selectedCharacter === "„ÅÇ„ÇÜ„ÇÄ"
                          ? "/images/ayumu.png"
                          : selectedCharacter === "„Åø„Åä„Å™"
                          ? "/images/miona.png"
                          : selectedCharacter === "„Åø„Å§„Åç"
                          ? "/images/mitsuki.png"
                          : selectedCharacter === "„ÇÑ„Å£„Å°„ÇÉ„Çì"
                          ? "/images/yattyan.png"
                          : hiraganaData.find(
                              (item) => item.character === selectedCharacter
                            )?.image || ""
                      }
                      alt={`${selectedCharacter}„ÅÆ„Ç§„É©„Çπ„Éà`}
                      className="w-24 h-24 sm:w-24 sm:h-24 object-contain"
                      onError={(e) => {
                        // ÁîªÂÉè„ÅåË™≠„ÅøËæº„ÇÅ„Å™„ÅÑÂ†¥Âêà„ÅØÈùûË°®Á§∫„Å´„Åô„Çã
                        e.currentTarget.style.display = "none";
                      }}
                    />
                  </div>
                )}
              </div>
            </div>

            {/* Êõ∏„ÅçÈ†ÜË™¨Êòé */}
            {selectedCharacter &&
              ((strokeOrderData[selectedCharacter] && (
                <div className="text-center text-xs sm:text-sm text-gray-600 mb-4">
                  {strokeOrderData[selectedCharacter].description}
                </div>
              )) ||
                (selectedCharacter === "„ÇÑ„Å≥„Åè „Åì„Å®" && (
                  <div className="text-center text-xs sm:text-sm text-gray-600 mb-4">
                    {kotoStrokeData.description}
                  </div>
                )))}

            {/* „Å™„Åû„ÇäÁ∑¥Áøí„Ç®„É™„Ç¢ */}
            <div className="bg-gray-50 rounded-lg p-4">
              <div className="flex justify-center items-center mb-2">
                <span className="text-xs sm:text-sm font-medium text-gray-700">
                  „Å™„Åû„Å£„Å¶ „Çå„Çì„Åó„ÇÖ„ÅÜ „Åó„Çà„ÅÜÔºÅ
                </span>
              </div>

              <div className="flex justify-end items-center gap-4">
                <canvas
                  ref={canvasRef}
                  width={280}
                  height={160}
                  className="border-2 border-dashed border-gray-300 rounded-lg bg-white cursor-crosshair block w-full max-w-[600px] sm:w-[600px] sm:h-[200px]"
                  onMouseDown={startTracing}
                  onMouseMove={trace}
                  onMouseUp={stopTracing}
                  onMouseLeave={stopTracing}
                  onTouchStart={startTracing}
                  onTouchMove={trace}
                  onTouchEnd={stopTracing}
                />

                <div className="flex flex-col justify-center gap-2 mt-2">
                  <Button
                    variant="outline"
                    size="default"
                    onClick={resetStrokes}
                    className="min-h-[44px] px-4 py-2"
                  >
                    <RotateCcw className="h-4 w-4 mr-1" />
                    „É™„Çª„ÉÉ„Éà
                  </Button>
                  <Button
                    variant="default"
                    size="default"
                    onClick={checkDrawing}
                    disabled={!hasUserDrawing}
                    className="bg-green-500 hover:bg-green-600 disabled:bg-gray-300 min-h-[44px] px-4 py-2"
                  >
                    „Åì„Çå„ÅßOK
                  </Button>
                </div>
              </div>
            </div>

            {/* page.tsx„Çπ„Çø„Ç§„É´„ÅÆËä±‰∏∏Ë°®Á§∫ */}
            {showHanamaru && (
              <div className="fixed inset-0 flex items-center justify-center z-50 animate-in fade-in duration-300 !mt-0 border-none rounded-sm">
                <div className="bg-white rounded-2xl p-4 sm:p-8 text-center shadow-2xl transform animate-in zoom-in-95 duration-500 relative overflow-hidden mx-4">
                  {/* „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà */}
                  <div className="absolute inset-0 pointer-events-none">
                    <div className="absolute top-4 left-4 text-yellow-400 animate-pulse">
                      ‚ú®
                    </div>
                    <div className="absolute top-6 right-6 text-pink-400 animate-bounce delay-100">
                      ‚≠ê
                    </div>
                    <div className="absolute bottom-8 left-8 text-blue-400 animate-pulse delay-200">
                      üí´
                    </div>
                    <div className="absolute bottom-4 right-4 text-purple-400 animate-bounce delay-300">
                      ‚ú®
                    </div>
                    <div className="absolute top-1/2 left-2 text-green-400 animate-pulse delay-150">
                      üåü
                    </div>
                    <div className="absolute top-1/2 right-2 text-red-400 animate-bounce delay-250">
                      ‚≠ê
                    </div>
                  </div>

                  {/* „É°„Ç§„É≥Ëä±‰∏∏ */}
                  <div className="relative z-10">
                    <div className="mb-2 sm:mb-4 flex justify-center">
                      <div className="w-16 h-16 sm:w-24 sm:h-24 text-4xl sm:text-6xl animate-bounce">
                        <img
                          src="/hanamaru.svg"
                          alt="„Çà„Åè„Åß„Åç„Åæ„Åó„Åü"
                          className="w-full h-full object-contain"
                        />
                      </div>
                    </div>
                    <div className="text-xl sm:text-3xl font-bold bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent mb-2 sm:mb-3 animate-pulse">
                      „Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ
                    </div>
                    {/* <div className="text-lg text-gray-600 animate-in slide-in-from-bottom-4 duration-700 delay-300">
                      „Äå{selectedCharacter}„Äç„Åå „Åò„Çá„ÅÜ„Åö„Å´ „Åã„Åë„Åæ„Åó„Åü„Å≠ÔºÅ
                    </div> */}

                    {/* ËøΩÂä†„ÅÆË£ÖÈ£æ */}
                    <div className="mt-4 flex justify-center space-x-2">
                      <div className="w-3 h-3 bg-pink-400 rounded-full animate-pulse"></div>
                      <div className="w-3 h-3 bg-purple-400 rounded-full animate-pulse delay-100"></div>
                      <div className="w-3 h-3 bg-blue-400 rounded-full animate-pulse delay-200"></div>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
